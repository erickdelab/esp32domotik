<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Ultimate</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #eceff1; text-align: center; margin: 0; padding-bottom: 50px; }
        
        /* HEADER Y CONEXI√ìN */
        .header { background: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .status-indicator { font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
        .connected { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .disconnected { background: #e74c3c; }

        /* BLOQUEO */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #263238; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .pin-input { font-size: 30px; letter-spacing: 10px; margin: 20px; font-weight: bold; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .keypad button { width: 70px; height: 70px; font-size: 24px; border-radius: 50%; border: none; cursor: pointer; background: rgba(255,255,255,0.1); color: white; transition: 0.2s; }
        .keypad button:active { background: rgba(255,255,255,0.3); }

        /* PANTALLA CONFIGURACI√ìN */
        #settings-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1500;
            flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .settings-box { background: #37474f; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: left; }
        .settings-box input { width: 90%; padding: 12px; margin: 8px 0; border-radius: 5px; border: none; }
        
        /* PANEL PRINCIPAL */
        #main-panel { display: none; padding: 15px; max-width: 600px; margin: auto; }
        .card { background: white; padding: 20px; margin: 15px 0; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card h3 { margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; color: #546e7a; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        
        /* BOTONES E INTERRUPTORES */
        .btn { padding: 10px 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; opacity: 0.7; }
        .btn.active-state { opacity: 1; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-on { background: #66bb6a; color: white; }
        .btn-off { background: #ef5350; color: white; }
        
        /* Toggle Switch para Alarmas */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; font-size: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(24px); }

        /* MICR√ìFONO */
        .mic-container { margin: 20px 0; }
        .btn-mic { width: 75px; height: 75px; border-radius: 50%; font-size: 32px; background: #29b6f6; color: white; border: none; box-shadow: 0 4px 10px rgba(41, 182, 246, 0.4); cursor: pointer; }
        
        /* ALERTAS */
        .status-badge { padding: 5px 10px; border-radius: 5px; font-size: 12px; color: white; font-weight: bold; }
        .bg-safe { background: #b0bec5; }
        .bg-danger { background: #e53935; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <!-- 0. HEADER CONECTIVIDAD -->
    <div class="header">
        <button onclick="abrirConfig()" style="background:none; border:none; font-size:24px; cursor:pointer;">‚öôÔ∏è</button>
        <div class="status-indicator">
            <div id="connDot" class="dot"></div>
            <span id="connText">Desconectado</span>
        </div>
    </div>

    <!-- 1. BLOQUEO PIN -->
    <div id="lock-screen">
        <h3>üîí SISTEMA DE SEGURIDAD</h3>
        <div class="pin-input" id="pinDisplay">_ _ _ _</div>
        <div class="keypad">
            <button onclick="addPin(1)">1</button><button onclick="addPin(2)">2</button><button onclick="addPin(3)">3</button>
            <button onclick="addPin(4)">4</button><button onclick="addPin(5)">5</button><button onclick="addPin(6)">6</button>
            <button onclick="addPin(7)">7</button><button onclick="addPin(8)">8</button><button onclick="addPin(9)">9</button>
            <button style="background:#d32f2f" onclick="clearPin()">C</button>
            <button onclick="addPin(0)">0</button>
            <button style="background:#388e3c" onclick="checkPin()">OK</button>
        </div>
    </div>

    <!-- 2. CONFIGURACI√ìN NOMBRES -->
    <div id="settings-screen">
        <div class="settings-box">
            <h3>‚öôÔ∏è Personalizar</h3>
            <label>Cuarto 1:</label><input type="text" id="inputC1" placeholder="Cocina">
            <label>Cuarto 2:</label><input type="text" id="inputC2" placeholder="Sala">
            <label>Cuarto 3:</label><input type="text" id="inputC3" placeholder="Rec√°mara">
            <label>Cuarto 4:</label><input type="text" id="inputC4" placeholder="Ba√±o">
            <button class="btn btn-on" style="width:100%; margin-top:20px;" onclick="guardarNombres()">Guardar</button>
            <button class="btn btn-off" style="width:100%; margin-top:10px;" onclick="cerrarConfig()">Cerrar</button>
        </div>
    </div>

    <!-- 3. PANEL PRINCIPAL -->
    <div id="main-panel">
        
        <!-- MICR√ìFONO -->
        <div class="mic-container">
            <button class="btn-mic" onclick="activarVoz()">üé§</button>
            <div id="textoVoz" style="margin-top:10px; color:#546e7a; font-style:italic;">Pulsa para hablar...</div>
        </div>

        <!-- TARJETA SEGURIDAD (CONFIGURABLE) -->
        <div class="card">
            <h3>üõ°Ô∏è Sistema de Alarmas</h3>
            
            <div class="toggle-row">
                <span>üîî Alarma Ultras√≥nica</span>
                <label class="switch">
                    <input type="checkbox" id="swUltra" onchange="toggleAlarma('activar_ultra', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="text-align:right; margin-bottom:10px;">
                Estado: <span id="stUltra" class="status-badge bg-safe">Seguro</span>
            </div>

            <div class="toggle-row">
                <span>üîî Alarma Infrarroja</span>
                <label class="switch">
                    <input type="checkbox" id="swIR" onchange="toggleAlarma('activar_ir', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="text-align:right;">
                Estado: <span id="stIR" class="status-badge bg-safe">Seguro</span>
            </div>
        </div>

        <!-- TARJETA PUERTA -->
        <div class="card">
            <h3>üö™ Acceso</h3>
            <button class="btn" id="btnPuerta" style="width:100%; background:#ffa000; color:white; padding:15px;" onclick="togglePuerta()">ABRIR / CERRAR</button>
            <p id="txtPuerta" style="text-align:center; font-weight:bold; margin-top:10px;">Cerrada</p>
        </div>

        <!-- TARJETA LUCES CON VISUALIZACI√ìN -->
        <div class="card">
            <h3>üí° Iluminaci√≥n y Clima</h3>
            <div style="margin-bottom:15px; font-size:14px; color:#78909c;">
                Temp: <b id="valTemp">--</b>¬∞C | Hum: <b id="valHum">--</b>% | Jard√≠n: <b id="valJardin">OFF</b>
            </div>

            <!-- Botones de Luces -->
            <div id="controlesLuces">
                <!-- Se llenan dinamicamente con JS para aplicar estilos -->
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "TU_API_KEY_AQUI", 
            authDomain: "esp23-8c60b.firebaseapp.com",
            databaseURL: "https://esp23-8c60b-default-rtdb.firebaseio.com",
            projectId: "esp23-8c60b",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // VARIABLES GLOBALES
        let nombres = { c1:"Cuarto 1", c2:"Cuarto 2", c3:"Cuarto 3", c4:"Cuarto 4" };
        let estadoPuerta = 0;
        let estadosLuces = { c1:0, c2:0, c3:0, c4:0 };

        // --- INICIO ---
        window.onload = function() {
            cargarNombres();
            renderizarBotonesLuces();
            checkConnection();
        };

        function checkConnection() {
            const connectedRef = db.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                const connected = snap.val();
                const dot = document.getElementById('connDot');
                const txt = document.getElementById('connText');
                if (connected) {
                    dot.className = "dot connected";
                    txt.innerText = "Conectado";
                } else {
                    dot.className = "dot disconnected";
                    txt.innerText = "Desconectado";
                }
            });
        }

        // --- L√ìGICA PIN Y BUZZER ---
        let pin = "";
        function addPin(n) { if(pin.length < 4) { pin += n; updatePinDisplay(); } }
        function clearPin() { pin = ""; updatePinDisplay(); }
        function updatePinDisplay() { document.getElementById('pinDisplay').innerText = "* ".repeat(pin.length) || "_ _ _ _"; }
        
        function checkPin() {
            if(pin === "1234") {
                // PIN CORRECTO -> Enviar c√≥digo 1 al Buzzer
                db.ref('casa/config/buzzer_accion').set(1);
                
                document.getElementById('lock-screen').style.display = "none";
                document.getElementById('main-panel').style.display = "block";
            } else {
                // PIN INCORRECTO -> Enviar c√≥digo 2 al Buzzer
                db.ref('casa/config/buzzer_accion').set(2);
                
                alert("Pin Incorrecto"); 
                clearPin(); 
            }
        }

        // --- CONTROL DE ALARMAS ---
        function toggleAlarma(tipo, activa) {
            db.ref('casa/config/' + tipo).set(activa);
        }

        // --- CONTROL DE HARDWARE ---
        function setLuz(cuarto, val) {
            db.ref('casa/control/' + cuarto).set(val);
        }

        function togglePuerta() {
            const nuevo = estadoPuerta === 0 ? 1 : 0;
            db.ref('casa/control/puerta').set(nuevo);
        }

        // --- RENDERIZADO DIN√ÅMICO DE LUCES ---
        function renderizarBotonesLuces() {
            const container = document.getElementById('controlesLuces');
            let html = '';
            
            const lista = [
                { id: 'cuarto1', name: nombres.c1, state: estadosLuces.c1 },
                { id: 'cuarto2', name: nombres.c2, state: estadosLuces.c2 },
                { id: 'cuarto3', name: nombres.c3, state: estadosLuces.c3 },
                { id: 'cuarto4', name: nombres.c4, state: estadosLuces.c4 }
            ];

            lista.forEach(l => {
                // Si estado es 1, el boton ON brilla. Si es 0, el boton OFF es solido
                const onClass = l.state === 1 ? 'btn-on active-state' : 'btn-on';
                const offClass = l.state === 0 ? 'btn-off active-state' : 'btn-off';
                
                html += `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span style="font-weight:bold; color:#455a64;">${l.name}</span>
                    <div>
                        <button class="btn ${onClass}" onclick="setLuz('${l.id}', 1)">ON</button>
                        <button class="btn ${offClass}" onclick="setLuz('${l.id}', 0)">OFF</button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- LECTURA DE DATOS EN TIEMPO REAL ---
        db.ref('casa').on('value', (snap) => {
            const data = snap.val();
            if(!data) return;

            // 1. Actualizar Luces (Para feedback visual)
            if(data.control) {
                estadosLuces.c1 = data.control.cuarto1;
                estadosLuces.c2 = data.control.cuarto2;
                estadosLuces.c3 = data.control.cuarto3;
                estadosLuces.c4 = data.control.cuarto4;
                estadoPuerta = data.control.puerta;
                
                renderizarBotonesLuces(); // Re-dibujar botones con estado actual
                
                // Puerta
                const btnP = document.getElementById('btnPuerta');
                if(estadoPuerta) {
                    btnP.style.background = "#ef5350"; // Rojo para cerrar
                    btnP.innerText = "CERRAR PUERTA";
                    document.getElementById('txtPuerta').innerText = "Abierta üîì";
                } else {
                    btnP.style.background = "#ffa000"; // Naranja para abrir
                    btnP.innerText = "ABRIR PUERTA";
                    document.getElementById('txtPuerta').innerText = "Cerrada üîí";
                }
            }

            // 2. Actualizar Sensores y Alarmas
            if(data.sensores) {
                document.getElementById('valTemp').innerText = data.sensores.temperatura;
                document.getElementById('valHum').innerText = data.sensores.humedad;
                document.getElementById('valJardin').innerText = data.sensores.luz_exterior || "OFF";

                // Badge Alarma Ultra
                const bgUltra = document.getElementById('stUltra');
                if(data.sensores.alerta_ultrasonico == 1) {
                    bgUltra.className = "status-badge bg-danger";
                    bgUltra.innerText = "INTRUSO DETECTADO";
                } else {
                    bgUltra.className = "status-badge bg-safe";
                    bgUltra.innerText = "Seguro";
                }

                // Badge Alarma IR
                const bgIR = document.getElementById('stIR');
                if(data.sensores.alerta_ir == 1) {
                    bgIR.className = "status-badge bg-danger";
                    bgIR.innerText = "VENTANA ABIERTA";
                } else {
                    bgIR.className = "status-badge bg-safe";
                    bgIR.innerText = "Cerrada";
                }
                
                // Sincronizar interruptores de alarma (Si se cambiaron desde otro cel)
                if(data.sensores.estado_alarma_ultra !== undefined) {
                    document.getElementById('swUltra').checked = data.sensores.estado_alarma_ultra;
                }
                if(data.sensores.estado_alarma_ir !== undefined) {
                    document.getElementById('swIR').checked = data.sensores.estado_alarma_ir;
                }
            }
        });

        // --- L√ìGICA CONFIG NOMBRES Y VOZ ---
        // (Misma l√≥gica previa de LocalStorage y VoiceRecognition)
        function abrirConfig() { document.getElementById('settings-screen').style.display = 'flex'; }
        function cerrarConfig() { document.getElementById('settings-screen').style.display = 'none'; }
        function guardarNombres() {
            nombres.c1 = document.getElementById('inputC1').value || "Cuarto 1";
            nombres.c2 = document.getElementById('inputC2').value || "Cuarto 2";
            nombres.c3 = document.getElementById('inputC3').value || "Cuarto 3";
            nombres.c4 = document.getElementById('inputC4').value || "Cuarto 4";
            localStorage.setItem('nombresCasa', JSON.stringify(nombres));
            renderizarBotonesLuces();
            cerrarConfig();
        }
        function cargarNombres() {
            const saved = localStorage.getItem('nombresCasa');
            if(saved) nombres = JSON.parse(saved);
        }

        // VOZ (Simplificada para integrar con nombres)
        function activarVoz() {
            const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Recognition) { alert("Navegador no compatible"); return; }
            const rec = new Recognition();
            rec.lang = 'es-ES';
            rec.start();
            document.getElementById('textoVoz').innerText = "Escuchando...";
            rec.onresult = (e) => {
                const txt = e.results[0][0].transcript.toLowerCase();
                document.getElementById('textoVoz').innerText = txt;
                procesarVoz(txt);
            }
        }

        function procesarVoz(txt) {
            const on = txt.includes("encender") || txt.includes("prender") || txt.includes("abrir");
            const off = txt.includes("apagar") || txt.includes("cerrar");
            
            if(txt.includes("puerta")) togglePuerta();
            else if(txt.includes(nombres.c1.toLowerCase())) setLuz('cuarto1', on ? 1 : 0);
            else if(txt.includes(nombres.c2.toLowerCase())) setLuz('cuarto2', on ? 1 : 0);
            else if(txt.includes(nombres.c3.toLowerCase())) setLuz('cuarto3', on ? 1 : 0);
            else if(txt.includes(nombres.c4.toLowerCase())) setLuz('cuarto4', on ? 1 : 0);
        }
    </script>
</body>
</html>