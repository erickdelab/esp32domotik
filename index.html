<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Pro</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eef2f3; text-align: center; margin: 0; }
        
        /* --- ESTILOS GENERALES --- */
        h1 { color: #2c3e50; margin-top: 20px; font-size: 24px; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-on { background: #27ae60; }
        .btn-off { background: #c0392b; }
        
        /* --- BLOQUEO DE SEGURIDAD --- */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .pin-input { font-size: 30px; letter-spacing: 10px; margin: 20px; font-weight: bold; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .keypad button { width: 65px; height: 65px; font-size: 22px; border-radius: 50%; border: none; cursor: pointer; background: rgba(255,255,255,0.1); color: white; }
        
        /* --- PANTALLA DE CONFIGURACI√ìN (NUEVO) --- */
        #settings-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1500;
            flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .settings-box { background: #34495e; padding: 20px; border-radius: 15px; width: 85%; max-width: 400px; }
        .settings-box input { width: 90%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
        .btn-gear { position: absolute; top: 15px; right: 15px; background: none; font-size: 24px; cursor: pointer; color: #333; }

        /* --- PANEL PRINCIPAL --- */
        #main-panel { display: none; padding: 20px; max-width: 600px; margin: auto; padding-bottom: 50px; }
        
        .card { background: white; padding: 20px; margin: 15px 0; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: left; }
        .card h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #7f8c8d; }
        
        .row { display: flex; justify-content: space-between; align-items: center; margin: 12px 0; }
        .room-name { font-weight: bold; color: #333; font-size: 16px; }

        /* --- ESTADOS Y ALERTAS --- */
        .status-box { padding: 8px; border-radius: 5px; color: white; font-weight: bold; text-align: center; font-size: 14px; margin-top: 5px; }
        .status-safe { background: #95a5a6; } 
        .status-danger { background: #e74c3c; animation: parpadeo 1s infinite; }
        .status-active { background: #f39c12; } 
        @keyframes parpadeo { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .btn-reset { background: #7f8c8d; font-size: 12px; padding: 5px 10px; margin-top: 5px; width: 100%; }

        /* --- MICR√ìFONO --- */
        .mic-wrapper { text-align: center; margin: 20px 0; }
        .btn-mic { 
            width: 70px; height: 70px; border-radius: 50%; font-size: 30px; 
            background: linear-gradient(145deg, #3498db, #2980b9); color: white; border: none; 
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4); cursor: pointer; transition: transform 0.2s;
        }
        .btn-mic:active { transform: scale(0.90); }
        .mic-status { font-style: italic; color: #555; margin-top: 10px; min-height: 20px; font-size: 14px; }

    </style>
</head>
<body>

    <!-- 1. PANTALLA DE BLOQUEO -->
    <div id="lock-screen">
        <div style="margin-bottom: 20px;">üîí ACCESO SEGURO</div>
        <div class="pin-input" id="pinDisplay">_ _ _ _</div>
        <div class="keypad">
            <button onclick="addPin(1)">1</button><button onclick="addPin(2)">2</button><button onclick="addPin(3)">3</button>
            <button onclick="addPin(4)">4</button><button onclick="addPin(5)">5</button><button onclick="addPin(6)">6</button>
            <button onclick="addPin(7)">7</button><button onclick="addPin(8)">8</button><button onclick="addPin(9)">9</button>
            <button style="background:#e74c3c" onclick="clearPin()">C</button>
            <button onclick="addPin(0)">0</button>
            <button style="background:#27ae60" onclick="checkPin()">OK</button>
        </div>
    </div>

    <!-- 2. PANTALLA DE CONFIGURACI√ìN (Renombrar cuartos) -->
    <div id="settings-screen">
        <div class="settings-box">
            <h3>‚öôÔ∏è Configuraci√≥n de Cuartos</h3>
            <p style="font-size: 14px; color: #ccc;">Cambia el nombre para usarlo con voz.</p>
            
            <label>Cuarto 1:</label> <input type="text" id="inputC1" placeholder="Ej: Cocina">
            <label>Cuarto 2:</label> <input type="text" id="inputC2" placeholder="Ej: Sala">
            <label>Cuarto 3:</label> <input type="text" id="inputC3" placeholder="Ej: Rec√°mara">
            <label>Cuarto 4:</label> <input type="text" id="inputC4" placeholder="Ej: Ba√±o">
            
            <button class="btn btn-on" style="width:100%; margin-top:15px;" onclick="guardarNombres()">üíæ GUARDAR Y SALIR</button>
            <button class="btn btn-off" style="width:100%; margin-top:10px;" onclick="cerrarConfig()">CANCELAR</button>
        </div>
    </div>

    <!-- 3. PANEL PRINCIPAL -->
    <div id="main-panel">
        <!-- Bot√≥n Configurar -->
        <button class="btn btn-gear" onclick="abrirConfig()">‚öôÔ∏è</button>
        
        <h1>üè° Control Residencial</h1>

        <!-- MICR√ìFONO -->
        <div class="mic-wrapper">
            <button class="btn-mic" onclick="activarVoz()">üé§</button>
            <div id="textoVoz" class="mic-status">Toca y di: "Encender cocina"...</div>
        </div>

        <!-- SENSORES Y ALARMAS -->
        <div class="card">
            <h3>üõ°Ô∏è Seguridad y Sensores</h3>
            
            <div style="margin-bottom: 15px;">
                <span>üö∂ Ultrasonido (Intruso):</span>
                <div id="alertUltra" class="status-box status-safe">Sin Movimiento</div>
                <button class="btn btn-reset" onclick="resetAlarma('alerta_ultrasonico')">üîï Desactivar Alarma</button>
            </div>

            <div style="margin-bottom: 15px;">
                <span>ü™ü Sensor Ventana:</span>
                <div id="alertIR" class="status-box status-safe">Cerrada</div>
                <button class="btn btn-reset" onclick="resetAlarma('alerta_ir')">üîï Resetear Estado</button>
            </div>

            <div style="margin-bottom: 15px;">
                <span>üí° Luz Exterior:</span>
                <div id="statusLuzExt" class="status-box status-safe">APAGADA</div>
            </div>
            
            <hr>
            <div style="display: flex; justify-content: space-around; font-size: 18px;">
                <span>üå°Ô∏è <b id="valTemp">--</b> ¬∞C</span>
                <span>üíß <b id="valHum">--</b> %</span>
            </div>
        </div>

        <!-- PUERTA -->
        <div class="card">
            <h3>üö™ Acceso Principal</h3>
            <button class="btn btn-door" style="width:100%; background:#f1c40f; color:black; padding:15px;" onclick="togglePuerta()">ABRIR / CERRAR</button>
            <p id="estadoPuertaTexto" style="text-align:center; font-weight:bold;">Estado: ...</p>
        </div>

        <!-- HABITACIONES (Nombres Din√°micos) -->
        <div class="card">
            <h3>üí° Iluminaci√≥n</h3>
            
            <div class="row">
                <span id="lblC1" class="room-name">Cuarto 1</span> 
                <div><button class="btn btn-on" onclick="setLuz('cuarto1', 1)">ON</button> <button class="btn btn-off" onclick="setLuz('cuarto1', 0)">OFF</button></div>
            </div>
            
            <div class="row">
                <span id="lblC2" class="room-name">Cuarto 2</span> 
                <div><button class="btn btn-on" onclick="setLuz('cuarto2', 1)">ON</button> <button class="btn btn-off" onclick="setLuz('cuarto2', 0)">OFF</button></div>
            </div>
            
            <div class="row">
                <span id="lblC3" class="room-name">Cuarto 3</span> 
                <div><button class="btn btn-on" onclick="setLuz('cuarto3', 1)">ON</button> <button class="btn btn-off" onclick="setLuz('cuarto3', 0)">OFF</button></div>
            </div>
            
            <div class="row">
                <span id="lblC4" class="room-name">Cuarto 4</span> 
                <div><button class="btn btn-on" onclick="setLuz('cuarto4', 1)">ON</button> <button class="btn btn-off" onclick="setLuz('cuarto4', 0)">OFF</button></div>
            </div>

        </div>
    </div>

    <!-- SDK FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- 1. CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "TU_API_KEY_AQUI", 
            authDomain: "esp23-8c60b.firebaseapp.com",
            databaseURL: "https://esp23-8c60b-default-rtdb.firebaseio.com",
            projectId: "esp23-8c60b",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. VARIABLES DE NOMBRES (Default) ---
        let nombres = {
            c1: "Cuarto 1",
            c2: "Cuarto 2",
            c3: "Cuarto 3",
            c4: "Cuarto 4"
        };

        // Al iniciar, cargamos nombres guardados
        window.onload = function() {
            cargarNombres();
        };

        // --- 3. L√ìGICA DE CONFIGURACI√ìN ---
        function abrirConfig() {
            document.getElementById('inputC1').value = nombres.c1;
            document.getElementById('inputC2').value = nombres.c2;
            document.getElementById('inputC3').value = nombres.c3;
            document.getElementById('inputC4').value = nombres.c4;
            document.getElementById('settings-screen').style.display = 'flex';
        }

        function cerrarConfig() {
            document.getElementById('settings-screen').style.display = 'none';
        }

        function guardarNombres() {
            // Obtener valores
            nombres.c1 = document.getElementById('inputC1').value || "Cuarto 1";
            nombres.c2 = document.getElementById('inputC2').value || "Cuarto 2";
            nombres.c3 = document.getElementById('inputC3').value || "Cuarto 3";
            nombres.c4 = document.getElementById('inputC4').value || "Cuarto 4";

            // Guardar en memoria del celular (LocalStorage)
            localStorage.setItem('misNombresCasa', JSON.stringify(nombres));

            // Actualizar interfaz
            actualizarInterfazNombres();
            cerrarConfig();
            alert("¬°Nombres guardados! Ahora puedes usar la voz con ellos.");
        }

        function cargarNombres() {
            const guardado = localStorage.getItem('misNombresCasa');
            if (guardado) {
                nombres = JSON.parse(guardado);
            }
            actualizarInterfazNombres();
        }

        function actualizarInterfazNombres() {
            document.getElementById('lblC1').innerText = nombres.c1;
            document.getElementById('lblC2').innerText = nombres.c2;
            document.getElementById('lblC3').innerText = nombres.c3;
            document.getElementById('lblC4').innerText = nombres.c4;
        }

        // --- 4. L√ìGICA PIN SEGURIDAD ---
        let pin = "";
        function addPin(n) { if(pin.length < 4) { pin += n; updatePinDisplay(); } }
        function clearPin() { pin = ""; updatePinDisplay(); }
        function updatePinDisplay() { document.getElementById('pinDisplay').innerText = "* ".repeat(pin.length) || "_ _ _ _"; }
        function checkPin() {
            if(pin === "1234") {
                document.getElementById('lock-screen').style.display = "none";
                document.getElementById('main-panel').style.display = "block";
            } else { alert("Pin Incorrecto"); clearPin(); }
        }

        // --- 5. CONTROL HARDWARE ---
        function setLuz(cuarto, val) { db.ref('casa/control/' + cuarto).set(val); }
        
        // RESETEAR ALARMAS: Pone la variable en 0 en Firebase
        function resetAlarma(tipo) {
            db.ref('casa/sensores/' + tipo).set(0);
        }

        let estadoPuertaActual = 0;
        function togglePuerta() {
            const nuevoEstado = estadoPuertaActual === 0 ? 1 : 0;
            db.ref('casa/control/puerta').set(nuevoEstado);
        }

        // --- 6. L√ìGICA DE VOZ AVANZADA (DIN√ÅMICA) ---
        function activarVoz() {
            const output = document.getElementById('textoVoz');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                alert("Navegador no compatible. Usa Chrome.");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.start();
            output.innerText = "Escuchando... üëÇ";
            output.style.color = "#d35400";

            recognition.onresult = function(event) {
                const comando = event.results[0][0].transcript.toLowerCase();
                output.innerText = 'Detectado: "' + comando + '"';
                output.style.color = "#333";
                procesarComandoDinamico(comando);
            };
        }

        function procesarComandoDinamico(texto) {
            // Palabras de acci√≥n
            const on = texto.includes("encender") || texto.includes("prender") || texto.includes("activar");
            const off = texto.includes("apagar") || texto.includes("desactivar");
            
            // 1. COMPARAR CON NOMBRES PERSONALIZADOS
            // Normalizamos a minusculas para comparar
            
            if (texto.includes(nombres.c1.toLowerCase())) {
                if (on) setLuz('cuarto1', 1); if (off) setLuz('cuarto1', 0);
            }
            else if (texto.includes(nombres.c2.toLowerCase())) {
                if (on) setLuz('cuarto2', 1); if (off) setLuz('cuarto2', 0);
            }
            else if (texto.includes(nombres.c3.toLowerCase())) {
                if (on) setLuz('cuarto3', 1); if (off) setLuz('cuarto3', 0);
            }
            else if (texto.includes(nombres.c4.toLowerCase())) {
                if (on) setLuz('cuarto4', 1); if (off) setLuz('cuarto4', 0);
            }
            // PUERTA (Siempre se llama puerta)
            else if (texto.includes("puerta")) {
                if (texto.includes("abrir")) db.ref('casa/control/puerta').set(1);
                if (texto.includes("cerrar")) db.ref('casa/control/puerta').set(0);
            }
            // ALARMA
            else if (texto.includes("alarma") && off) {
                resetAlarma('alerta_ultrasonico');
                resetAlarma('alerta_ir');
            }
        }

        // --- 7. LECTURA EN TIEMPO REAL ---
        db.ref('casa').on('value', (snap) => {
            const data = snap.val();
            if(!data) return;

            // Sensores y Clima
            const sens = data.sensores;
            document.getElementById('valTemp').innerText = sens.temperatura;
            document.getElementById('valHum').innerText = sens.humedad;

            // Alerta Ultrasonico
            const divUltra = document.getElementById('alertUltra');
            if(sens.alerta_ultrasonico == 1) {
                divUltra.innerText = "¬°INTRUSO DETECTADO!";
                divUltra.className = "status-box status-danger";
            } else {
                divUltra.innerText = "Sin movimiento";
                divUltra.className = "status-box status-safe";
            }

            // Alerta IR
            const divIR = document.getElementById('alertIR');
            if(sens.alerta_ir == 1) {
                divIR.innerText = "¬°VENTANA ABIERTA!";
                divIR.className = "status-box status-danger";
            } else {
                divIR.innerText = "Segura";
                divIR.className = "status-box status-safe";
            }

            // Luz Exterior
            const divLuz = document.getElementById('statusLuzExt');
            if(sens.luz_exterior == "ON") {
                divLuz.innerText = "NOCHE (ENCENDIDA)";
                divLuz.className = "status-box status-active";
            } else {
                divLuz.innerText = "D√çA (APAGADA)";
                divLuz.className = "status-box status-safe";
            }

            // Puerta
            estadoPuertaActual = data.control.puerta;
            document.getElementById('estadoPuertaTexto').innerText = estadoPuertaActual ? "üîì ABIERTA" : "üîí CERRADA";
        });
    </script>
</body>
</html>